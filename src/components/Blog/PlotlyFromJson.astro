---
export interface Props {
	host?: string;
	baseURL?: string;
	bucket?: string;
	filepath?: string;
	src?: string;
	protocol?: "https" | "http";
	height?: string;
	class?: string;
	loadingText?: string;
	notes?: string | string[];
}

const {
	host,
	baseURL,
	bucket,
	filepath,
	src,
	protocol = "https",
	height = "420px",
	class: className = "",
	loadingText = "Loading chart...",
	notes,
} = Astro.props;

const resolvedHost = (host ?? baseURL)?.replace(/\/+$/, "");
const normalizedPath = filepath?.replace(/^\/+/, "");
const objectUrl =
	src ??
	(resolvedHost && bucket && normalizedPath
		? `${protocol}://${resolvedHost}/${bucket}/${normalizedPath}`
		: null);

if (!objectUrl) {
	throw new Error(
		"PlotlyFromJson requires either src or (host + bucket + filepath) props.",
	);
}

const chartId = `plotly-${Math.random().toString(36).slice(2, 10)}`;
const statusId = `${chartId}-status`;
---

<div class={`plotly-json-embed ${className}`}>
	<div id={chartId} style={`width: 100%; height: ${height};`}></div>
	<p id={statusId} class="plotly-status">{loadingText}</p>
	{
		notes && (
			<div class="plotly-notes">
				{(Array.isArray(notes) ? notes : notes.split("\n")).map(
					(note) => (
						<p>{note}</p>
					),
				)}
			</div>
		)
	}
</div>

<script define:vars={{ chartId, statusId, objectUrl }}>
	const chartEl = document.getElementById(chartId);
	const statusEl = document.getElementById(statusId);

	const loadPlotly = async () => {
		if (window.Plotly) return window.Plotly;
		if (window.__plotlyLoaderPromise) return window.__plotlyLoaderPromise;

		window.__plotlyLoaderPromise = new Promise((resolve, reject) => {
			const script = document.createElement("script");
			script.src = "https://cdn.plot.ly/plotly-2.35.2.min.js";
			script.async = true;
			script.onload = () => resolve(window.Plotly);
			script.onerror = () =>
				reject(new Error("Failed to load Plotly CDN script."));
			document.head.appendChild(script);
		});

		return window.__plotlyLoaderPromise;
	};

	const normalizeFigure = (figure) => {
		if (Array.isArray(figure)) {
			return { data: figure, layout: {}, config: {} };
		}
		if (figure && Array.isArray(figure.data)) {
			return {
				data: figure.data,
				layout: figure.layout ?? {},
				config: figure.config ?? {},
			};
		}
		throw new Error(
			"JSON must be a Plotly figure object ({ data, layout?, config? }).",
		);
	};

	(async () => {
		if (!chartEl) return;

		try {
			const [Plotly, response] = await Promise.all([
				loadPlotly(),
				fetch(objectUrl, { mode: "cors" }),
			]);

			if (!response.ok) {
				throw new Error(
					`HTTP ${response.status} while fetching chart JSON.`,
				);
			}

			const figure = normalizeFigure(await response.json());
			await Plotly.newPlot(chartEl, figure.data, figure.layout, {
				responsive: true,
				...figure.config,
			});

			statusEl?.remove();
		} catch (error) {
			const message =
				error instanceof Error
					? error.message
					: "Unknown error while loading chart.";
			if (statusEl)
				statusEl.textContent = `Could not load chart: ${message}`;
			console.error("PlotlyFromJson error:", error);
		}
	})();
</script>

<style>
	.plotly-json-embed {
		margin: 1.5rem 0;
	}

	.plotly-status {
		margin-top: 0.75rem;
		font-size: 0.95rem;
		opacity: 0.75;
	}

	.plotly-notes {
		margin-top: 0;
		padding-top: 0;
		margin-left: auto;
		margin-right: auto;
		max-width: 70%;
		color: rgb(148 163 184 / 0.8);
		font-size: 0.9rem;
		line-height: 1.2;
		text-align: center;
	}

	.plotly-notes p + p {
		margin-top: 0.3rem;
	}

	@media (max-width: 720px) {
		.plotly-notes {
			max-width: 100%;
		}
	}
</style>
